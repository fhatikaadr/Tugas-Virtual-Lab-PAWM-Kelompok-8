<!DOCTYPE html>
<html lang="id">
<head>
  <script src="/src/js/supabase-client.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhySphere ‚Äî Register</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/src/css/style.css">
  <style>
    body {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #4facfe 100%);
      position: relative;
      overflow: hidden;
    }
    
    /* Animated background particles */
    .particle {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      animation: float 20s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) rotate(360deg); opacity: 0; }
    }
    
    /* Electron orbit animation */
    .electron-orbit {
      position: absolute;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      animation: spin 10s linear infinite;
    }
    
    .electron {
      position: absolute;
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Wave animation */
    .wave {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 200%;
      height: 200px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z' fill='rgba(255,255,255,0.1)'/%3E%3C/svg%3E");
      background-size: 50% 100%;
      animation: wave 15s linear infinite;
    }
    
    @keyframes wave {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    
    /* Glassmorphism card */
    .glass-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      padding: 2.5rem;
      animation: slideUp 0.6s ease-out;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Input styles */
    .physics-input {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      width: 100%;
      transition: all 0.3s ease;
      font-size: 1rem;
    }
    
    .physics-input:focus {
      outline: none;
      border-color: #f5576c;
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 0 3px rgba(245, 87, 108, 0.1);
    }
    
    /* Button styles */
    .physics-btn {
      background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.875rem 2rem;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .physics-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(245, 87, 108, 0.5);
    }
    
    .physics-btn:active {
      transform: translateY(0);
    }
    
    .physics-btn-secondary {
      background: rgba(255, 255, 255, 0.9);
      color: #f5576c;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .physics-btn-secondary:hover {
      background: rgba(255, 255, 255, 1);
      border-color: #f5576c;
    }
    
    /* Atom structure for logo */
    .atom-container {
      position: relative;
      width: 80px;
      height: 80px;
    }
    
    .nucleus {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
      z-index: 10;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <!-- Animated particles -->
  <div class="particle" style="width: 70px; height: 70px; left: 15%; top: 15%; --tx: 120px; --ty: -170px; animation-delay: 0s;"></div>
  <div class="particle" style="width: 50px; height: 50px; left: 75%; top: 25%; --tx: -140px; --ty: 220px; animation-delay: 2s;"></div>
  <div class="particle" style="width: 90px; height: 90px; left: 45%; top: 8%; --tx: 90px; --ty: 200px; animation-delay: 4s;"></div>
  <div class="particle" style="width: 35px; height: 35px; left: 25%; top: 75%; --tx: -100px; --ty: -110px; animation-delay: 1s;"></div>
  <div class="particle" style="width: 60px; height: 60px; left: 65%; top: 85%; --tx: 130px; --ty: -150px; animation-delay: 3s;"></div>
  
  <!-- Electron orbits (decorative) -->
  <div class="electron-orbit" style="width: 400px; height: 400px; top: 50%; left: 10%; transform: translate(-50%, -50%) rotateX(60deg); animation-duration: 15s;">
    <div class="electron" style="top: -6px; left: 50%; transform: translateX(-50%);"></div>
  </div>
  <div class="electron-orbit" style="width: 300px; height: 300px; top: 30%; right: 5%; transform: translate(50%, -50%) rotateX(70deg); animation-duration: 12s; animation-direction: reverse;">
    <div class="electron" style="bottom: -6px; left: 50%; transform: translateX(-50%);"></div>
  </div>
  
  <!-- Wave -->
  <div class="wave"></div>
  
  <div class="max-w-md w-full p-6 relative z-10">
    <div class="glass-card">
      <!-- Atom Logo/Icon -->
      <div class="flex justify-center mb-6">
        <div class="atom-container">
          <div class="nucleus"></div>
          <div class="electron-orbit" style="width: 80px; height: 80px; top: 0; left: 0;">
            <div class="electron" style="top: -6px; left: 50%; transform: translateX(-50%);"></div>
          </div>
          <div class="electron-orbit" style="width: 80px; height: 80px; top: 0; left: 0; transform: rotate(60deg);">
            <div class="electron" style="top: -6px; left: 50%; transform: translateX(-50%);"></div>
          </div>
          <div class="electron-orbit" style="width: 80px; height: 80px; top: 0; left: 0; transform: rotate(120deg);">
            <div class="electron" style="top: -6px; left: 50%; transform: translateX(-50%);"></div>
          </div>
        </div>
      </div>
      
      <h2 class="text-3xl font-bold text-white text-center mb-2">Daftar PhySphere</h2>
      <p class="text-white/80 text-center mb-8 text-sm">Bergabung dalam eksplorasi fisika</p>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-white/90 mb-2">üë§ Nama Lengkap</label>
          <input id="reg-name" type="text" class="physics-input" placeholder="Contoh: Nikola Tesla">
        </div>

        <div>
          <label class="block text-sm font-medium text-white/90 mb-2">üìß Email</label>
          <input id="reg-email" type="email" class="physics-input" placeholder="nama@email.com">
        </div>

        <div>
          <label class="block text-sm font-medium text-white/90 mb-2">üîê Password</label>
          <input id="reg-password" type="password" class="physics-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>

        <div id="reg-msg" class="text-sm text-yellow-200 font-medium min-h-[1.25rem]"></div>

        <div class="flex gap-3 pt-2">
          <button id="reg-submit" class="physics-btn flex-1">
            Daftar Sekarang
          </button>
          <a href="/" class="physics-btn physics-btn-secondary flex-shrink-0">
            Kembali
          </a>
        </div>
      </div>

      <div class="mt-6 pt-6 border-t border-white/20">
        <p class="text-center text-white/80 text-sm">
          Sudah punya akun? 
          <a href="/login" class="text-yellow-200 font-semibold hover:text-yellow-100 transition-colors">Masuk Sekarang</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    (function(){
      function el(id){return document.getElementById(id)}

      // Cek apakah sudah login dengan Supabase (tunggu inisialisasi client dulu)
      (async function() {
        try {
          await (window.__supabaseReady || Promise.resolve());
        } catch(e) {
          console.error('Supabase init error', e);
        }
        if (!window.supabase) return;
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          // User sudah login, lempar ke halaman utama
          window.location.href = '/PhySphere';
        }
      })();

      // Ganti logika 'click' dengan Supabase
      el('reg-submit').addEventListener('click', async function(){
        const name = (el('reg-name').value||'').trim();
        const email = (el('reg-email').value||'').trim().toLowerCase();
        const pass = el('reg-password').value||'';
        const msg = el('reg-msg'); msg.textContent = '';
        
        if(!email || !pass){ msg.textContent = 'Email dan password wajib diisi.'; return; }
        // ensure Supabase SDK is initialized before using auth
        try{ await (window.__supabaseReady || Promise.resolve()); }catch(e){ console.error('Supabase init error (register)', e); }
        if (!window.supabase) { msg.textContent = 'SDK Supabase gagal dimuat. Cek console untuk detail.'; return; }

        // LOGIKA SUPABASE BARU
        msg.textContent = 'Mendaftarkan...';
        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: pass,
          options: {
            data: {
              // Data ini akan ditangkap oleh Trigger yang kita buat di Tahap 1
              full_name: name 
            }
          }
        });

        if (error) {
          msg.textContent = 'Error: ' + error.message;
          return;
        }

        // Jika ada error server-side, tampilkan
        msg.textContent = '';

        // Supabase may require email confirmation. If a user object is
        // returned immediately we can create a profile row client-side.
        const newUser = data?.user || (data?.session && data.session.user) || null;
        if (!newUser) {
          // No immediate user (likely requires email confirmation)
          msg.textContent = 'Registrasi berhasil. Silakan cek email untuk konfirmasi sebelum masuk.';
          return;
        }

        // Buat/memperbarui profile client-side (safe upsert). This avoids
        // needing a DB trigger and works when RLS allows authenticated inserts.
        try {
          const up = await supabase.from('profile').upsert({
            id: newUser.id,
            full_name: name,
            email: email,
            // Start with default materi_progress where all modules are false
            materi_progress: { "ghs": false, "pegas": false, "bandul": false, "getaran": false },
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' });
          if (up.error) {
            console.error('Profile upsert error', up.error);
            msg.textContent = 'Error: ' + (up.error.message || 'Database error saving new user');
            // Still allow redirect (user account created) but warn in UI
            setTimeout(()=>{ try{ window.location.href = '/PhySphere'; }catch(e){} }, 1600);
            return;
          }
        } catch(e) {
          console.error('Profile upsert exception', e);
          msg.textContent = 'Error: ' + (e.message || String(e));
          setTimeout(()=>{ try{ window.location.href = '/PhySphere'; }catch(e){} }, 1600);
          return;
        }

        msg.textContent = 'Registrasi berhasil! Mengarahkan...';
        // Redirect to main (use absolute route so rewrites work)
        try{ sessionStorage.setItem('pysphere_active_page','beranda'); }catch(e){}
        window.location.href = '/PhySphere';
      });
    })();
  </script>
</body>
</html>
